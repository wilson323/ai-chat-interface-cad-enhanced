# 架构一致性指引

- 目标：保证全局架构一致性、可演进性与生产级稳定性；避免功能重复与冗余。
- 范畴：Next.js 全栈、AG-UI 协议集成、CAD 分析、AI 适配器、缓存与重试、监控与回退。

## 一、分层与边界（Clean Architecture）
- UI 层（`app/`, `components/`）：仅负责渲染与交互，不承载业务规则。
- 应用层（`lib/services`, `lib/managers`, `hooks/`）：用例编排、流程控制、错误边界、重试与幂等。
- 领域层（`lib/types`, `lib/conversation`, 纯函数模型）：业务规则与不变式，避免外部依赖。
- 基础设施（`app/api/*`, `lib/api`, `lib/cache`, `lib/database`）：I/O 集成（DB/HTTP/文件/Redis）。

约束：
- 下层不得依赖上层；UI 不直接访问基础设施；通过应用层/服务提供能力。
- 共享类型位于 `lib/types`，禁止在多处重复定义。

## 二、AI 适配器与 OpenAI 协议
- 必须通过统一 AI 适配器（`lib/api/ai-provider-adapter.ts` 或衔接的上游）访问任意模型，严禁直连 SDK。
- 请求与响应遵循 OpenAI 兼容协议；嵌入模型与聊天/多模态模型类型区分清晰（不同路由/不同 DTO）。
- 新模型接入：先扩展适配器与配置（`config/models.config.ts`），再在服务层接入，最后在 UI 暴露配置。

## 三、可靠性（重试/降级/缓存）
- 重试：使用 `lib/retry/retry-manager.ts`，统一指数退避与最大尝试次数。
- 缓存：通过 `lib/cache` 统一入口；定义明确的 key 策略与 TTL；禁止临时全局变量缓存。
- 降级：外部服务异常时，返回稳定错误码与用户可理解文案；记录详细上下文。

## 四、错误处理与日志
- 错误通过 `lib/errors/error-handler.ts` 统一落库与上报；API Route 必须 try-catch 并输出稳定结构。
- 日志分级（info/warn/error），禁止吞错；生产环境移除无关 console。

## 五、性能与并发
- I/O 合并、批量接口使用（参考 `lib/batch` 与 `app/api/ag-ui/batch-forward`）。
- 前端流式渲染与增量加载（`lib/ag-ui/stream-optimizer.ts`）。

## 六、测试与验证
- E2E：`playwright.config.ts` 已启用 `webServer`，使用 `npm run test:e2e` 运行。
- 覆盖率：>80%；关键用例包含异常路径、超时、鉴权、限流。
- 禁止任何 mock 数据/服务进入生产逻辑；测试也应利用真实最小化环境。

## 七、Windows 环境规范
- 仅使用 PowerShell 命令；避免 *nix 专有语法；脚本需兼容 Windows。

## 八、变更与文档更新
- 新增/修改架构相关能力时，必须同步更新本指引与关联文档，并在 PR 说明“变更缘由”。
- 新建模块前，需全局检索避免功能重复；优先在既有模块扩展而非重复实现。

## 九、提交清单（片段）
- 层次边界未被穿透；类型未重复；AI 适配器遵循协议；无 mock；错误与日志合规；测试通过。
