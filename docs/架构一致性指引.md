# 架构一致性指引

- 目标：保证全局架构一致性、可演进性与生产级稳定性；避免功能重复与冗余。
- 范畴：Next.js 全栈、AG-UI 协议集成、CAD 分析、AI 适配器、缓存与重试、监控与回退。

## 一、分层与边界（Clean Architecture）
- UI 层（`app/`, `components/`）：仅负责渲染与交互，不承载业务规则。
- 应用层（`lib/services`, `lib/managers`, `hooks/`）：用例编排、流程控制、错误边界、重试与幂等。
- 领域层（`lib/types`, `lib/conversation`, 纯函数模型）：业务规则与不变式，避免外部依赖。
- 基础设施（`app/api/*`, `lib/api`, `lib/cache`, `lib/database`）：I/O 集成（DB/HTTP/文件/Redis）。

约束：
- 下层不得依赖上层；UI 不直接访问基础设施；通过应用层/服务提供能力。
- 共享类型位于 `lib/types`，禁止在多处重复定义。

## 二、AI 适配器与 OpenAI 协议
- 必须通过统一 AI 适配器（`lib/api/ai-provider-adapter.ts` 或衔接的上游）访问任意模型，严禁直连 SDK。
- 请求与响应遵循 OpenAI 兼容协议；嵌入模型与聊天/多模态模型类型区分清晰（不同路由/不同 DTO）。
- 新模型接入：先扩展适配器与配置（`config/models.config.ts`），再在服务层接入，最后在 UI 暴露配置。

## 三、可靠性（重试/降级/缓存）
- 重试：使用 `lib/retry/retry-manager.ts`，统一指数退避与最大尝试次数。
- 缓存：通过 `lib/cache` 统一入口；定义明确的 key 策略与 TTL；禁止临时全局变量缓存。
- 降级：外部服务异常时，返回稳定错误码与用户可理解文案；记录详细上下文。

## 四、错误处理与日志
- 错误通过 `lib/errors/error-handler.ts` 统一落库与上报；API Route 必须 try-catch 并输出稳定结构。
- 日志分级（info/warn/error），禁止吞错；生产环境移除无关 console。

## 五、性能与并发
- I/O 合并、批量接口使用（参考 `lib/batch` 与 `app/api/ag-ui/batch-forward`）。
- 前端流式渲染与增量加载（`lib/ag-ui/stream-optimizer.ts`）。

## 六、测试与验证
- E2E：`playwright.config.ts` 已启用 `webServer`，使用 `npm run test:e2e` 运行。
- 覆盖率：>80%；关键用例包含异常路径、超时、鉴权、限流。
- 禁止任何 mock 数据/服务进入生产逻辑；测试也应利用真实最小化环境。

## 七、Windows 环境规范
- 仅使用 PowerShell 命令；避免 *nix 专有语法；脚本需兼容 Windows。

## 八、变更与文档更新
- 新增/修改架构相关能力时，必须同步更新本指引与关联文档，并在 PR 说明“变更缘由”。
- 新建模块前，需全局检索避免功能重复；优先在既有模块扩展而非重复实现。

## 九、提交清单（片段）
- 层次边界未被穿透；类型未重复；AI 适配器遵循协议；无 mock；错误与日志合规；测试通过。

## 十、AI 适配器扩展步骤（OpenAI 协议兼容）

1. 明确模型能力与类型
   - 区分：聊天/多模态、音频、图像、嵌入（Embedding）。
   - 确认速率、上下文长度、定价、地区可用性、鉴权方式。
2. 配置声明
   - 在 `config/models.config.ts` 增加模型元数据（标识、能力、限速、默认参数）。
   - 如涉及开关，在 `config/features.ts` 增加显式开关项。
3. 类型与契约
   - 在 `lib/types` 增补必要 DTO/枚举，避免 UI/服务重复定义类型。
   - 确保与 OpenAI 兼容的请求/响应结构（区分不同模型类型）。
4. 适配器实现
   - 在 `lib/api/ai-provider-adapter.ts` 或上游调用链扩展路由选择与参数映射。
   - 禁止直接使用第三方 SDK；统一走适配器转译（headers、payload、流式处理）。
5. 服务层对接
   - 在 `lib/api/fastgpt-enhanced.ts`、`lib/api/fastgpt-optimizer.ts` 等处按需接入，保持幂等与重试策略。
   - 若新增 API 路由，置于 `app/api/proxy/ai/*` 并遵循鉴权、限流、超时与错误结构规范。
6. 观测性与异常
   - 使用 `lib/errors/error-handler.ts` 上报；日志分级；必要处打埋点。
   - 标准化错误码与对外文案，保留内部上下文。
7. 测试与验证
   - E2E：为新增能力编写 Playwright 测试（成功/失败/超时/鉴权）。
   - 性能：必要时加入批量/流式场景验证。
8. 文档与规则
   - 更新本指引与相关开发文档；在 `.cursor/rules` 检查是否需新增/调整规则项。

## 附：PR 模板（复制到描述区）

```md
### 标题
feat(adapter): 接入 <Provider>/<Model>（OpenAI 协议兼容）

### 摘要
- 动机/业务价值：
- 关键能力：

### 架构影响
- 分层边界：UI / 应用 / 领域 / 基础设施 变更点
- 是否有跨层依赖：

### AI 适配器变更
- 新增/修改文件：`lib/api/ai-provider-adapter.ts`, `config/models.config.ts`, `app/api/proxy/ai/*`
- OpenAI 兼容性说明（请求/响应/流式）：

### 契约与安全
- API 契约变更：
- 鉴权/限流/超时：

### 错误与降级
- 标准错误码：
- 降级策略：

### 测试
- E2E 覆盖：成功/失败/超时/鉴权
- 覆盖率目标：>80%

### 文档
- 已更新：`docs/架构一致性指引.md`、其它相关文档

### 风险与回滚
- 已知风险：
- 回滚方案：
```
