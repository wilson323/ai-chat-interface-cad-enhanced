---
alwaysApply: true
---
# ZK-Agent CI/CD è§„èŒƒ - Linux Ubuntuç”Ÿäº§ç¯å¢ƒ

## ğŸ“‹ CI/CDæ ¸å¿ƒåŸåˆ™

åŸºäº [CI/CDæŒ‡å¯¼æ–‡æ¡£](mdc:docs/CI_CD_GUIDELINES.md) å’Œ [é¡¹ç›®æ¶æ„è§„èŒƒ](mdc:.cursor/rules/01-project-architecture.mdc)ï¼Œä¸“é—¨ä¸ºLinux Ubuntuç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ã€‚

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
- **è´¨é‡ä¼˜å…ˆ**: æ¯ä¸ªé˜¶æ®µéƒ½å¿…é¡»é€šè¿‡ä¸¥æ ¼çš„è´¨é‡é—¨ç¦
- **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**: æ‰€æœ‰æ£€æŸ¥å’Œéƒ¨ç½²éƒ½å¿…é¡»è‡ªåŠ¨åŒ–
- **å¿«é€Ÿåé¦ˆ**: CI/CDæµç¨‹å¿…é¡»åœ¨10åˆ†é’Ÿå†…ç»™å‡ºåé¦ˆ
- **é›¶åœæœºéƒ¨ç½²**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¿…é¡»ç¡®ä¿é›¶åœæœº
- **å¯è§‚æµ‹æ€§**: å…¨æµç¨‹å¯ç›‘æ§ã€å¯è¿½è¸ªã€å¯å›æ»š

### Linux Ubuntuç”Ÿäº§ç¯å¢ƒæŠ€æœ¯æ ˆ
- **ç”Ÿäº§ç¯å¢ƒ**: Ubuntu 22.04 LTS Server
- **CI/CDå¹³å°**: GitHub Actions (ä¸») + GitLab CI (å¤‡é€‰)
- **å®¹å™¨åŒ–**: Docker + Docker Compose + Kubernetes
- **åˆ¶å“ç®¡ç†**: GitHub Container Registry + Docker Hub
- **ç›‘æ§å‘Šè­¦**: Prometheus + Grafana + Jaeger
- **å®‰å…¨æ‰«æ**: Trivy + Snyk + CodeQL
- **åŒ…ç®¡ç†**: APT + Snap (Ubuntuç‰¹æœ‰)

## ğŸ”„ CIæµç¨‹è§„èŒƒ - Ubuntuä¼˜åŒ–

### GitHub Actionså·¥ä½œæµé…ç½®
```yaml
# âœ… Ubuntuç”Ÿäº§ç¯å¢ƒCIå·¥ä½œæµ
name: ğŸš€ ZK-Agent CI/CD Pipeline (Ubuntu Production)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥å®‰å…¨æ‰«æ

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: zk-agent
  UBUNTU_VERSION: '22.04'

jobs:
  # é˜¶æ®µ1ï¼šä»£ç è´¨é‡æ£€æŸ¥ - Ubuntuç¯å¢ƒ
  code-quality:
    name: ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥ (Ubuntu)
    runs-on: ubuntu-22.04  # ä½¿ç”¨ä¸ç”Ÿäº§ç¯å¢ƒç›¸åŒçš„Ubuntuç‰ˆæœ¬
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…Ubuntuç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libpq-dev redis-tools

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          npm ci
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: ğŸ” ESLintæ£€æŸ¥
        run: |
          npm run lint:check
          npm run lint:report

      - name: ğŸ Pythonä»£ç æ£€æŸ¥
        run: |
          black --check .
          flake8 .
          mypy .
          isort --check-only .

      - name: ğŸ“Š TypeScriptç¼–è¯‘æ£€æŸ¥
        run: npm run type-check

      - name: ğŸš« è´¨é‡é—¨ç¦æ£€æŸ¥
        run: |
          node scripts/quality-gate.js
        env:
          MIN_COVERAGE: 85
          MAX_COMPLEXITY: 10
          MAX_DUPLICATION: 3

  # é˜¶æ®µ2ï¼šå®‰å…¨æ‰«æ - Ubuntuä¸“ç”¨
  security-scan:
    name: ğŸ”’ å®‰å…¨æ‰«æ (Ubuntu)
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” CodeQLä»£ç å®‰å…¨åˆ†æ
        uses: github/codeql-action/init@v2
        with:
          languages: typescript, python

      - name: ğŸ—ï¸ è‡ªåŠ¨æ„å»º
        uses: github/codeql-action/autobuild@v2

      - name: ğŸ” æ‰§è¡ŒCodeQLåˆ†æ
        uses: github/codeql-action/analyze@v2

      - name: ğŸ“¦ ä¾èµ–å®‰å…¨æ‰«æ
        run: |
          # Node.jsä¾èµ–æ‰«æ
          npm audit --audit-level=high
          npx snyk test --severity-threshold=high

          # Pythonä¾èµ–æ‰«æ
          pip-audit --require-hashes --desc
          safety check --full-report

      - name: ğŸ³ Ubuntu Dockeré•œåƒå®‰å…¨æ‰«æ
        run: |
          docker build -t temp-image .
          trivy image --exit-code 1 --severity HIGH,CRITICAL temp-image

      - name: ğŸ” æ•æ„Ÿä¿¡æ¯æ£€æµ‹
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # é˜¶æ®µ3ï¼šå•å…ƒæµ‹è¯• - å¤šUbuntuç‰ˆæœ¬å…¼å®¹æ€§
  unit-tests:
    name: ğŸ§ª å•å…ƒæµ‹è¯• (Ubuntu)
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    strategy:
      matrix:
        ubuntu-version: [20.04, 22.04]
        node-version: [18, 20]
        python-version: [3.11, 3.12]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒ
        uses: ./.github/actions/setup-ubuntu-environment
        with:
          ubuntu-version: ${{ matrix.ubuntu-version }}
          node-version: ${{ matrix.node-version }}
          python-version: ${{ matrix.python-version }}

      - name: ğŸ§ª å‰ç«¯å•å…ƒæµ‹è¯•
        run: |
          npm run test:unit
          npm run test:coverage

      - name: ğŸ åç«¯å•å…ƒæµ‹è¯•
        run: |
          pytest tests/unit/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=85 \
            --junitxml=test-results.xml

  # é˜¶æ®µ4ï¼šé›†æˆæµ‹è¯• - UbuntuæœåŠ¡é›†æˆ
  integration-tests:
    name: ğŸ”— é›†æˆæµ‹è¯• (Ubuntu Services)
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [unit-tests]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: zk_agent_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Ubuntuç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client redis-tools

      - name: ğŸ³ å¯åŠ¨æœåŠ¡
        run: |
          docker-compose -f docker-compose.ubuntu.yml up -d

      - name: â³ ç­‰å¾…æœåŠ¡å°±ç»ª
        run: |
          timeout 300s bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'

      - name: ğŸ”— APIé›†æˆæµ‹è¯•
        run: |
          npm run test:integration
          pytest tests/integration/ --maxfail=5

  # é˜¶æ®µ5ï¼šæ„å»ºUbuntuä¼˜åŒ–é•œåƒ
  build-ubuntu-images:
    name: ğŸ³ æ„å»ºUbuntuä¼˜åŒ–é•œåƒ
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [code-quality, security-scan, unit-tests]
    if: github.event_name == 'push'

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=ubuntu-
            type=raw,value=ubuntu-latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ æ„å»ºUbuntuä¼˜åŒ–é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.ubuntu
          platforms: linux/amd64  # Ubuntuç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            UBUNTU_VERSION=22.04
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
            REVISION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}

      - name: ğŸ” Ubuntué•œåƒå®‰å…¨æ‰«æ
        run: |
          trivy image --exit-code 1 --severity HIGH,CRITICAL \
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}:ubuntu-${{ github.sha }}
```

## ğŸš€ Ubuntuç”Ÿäº§éƒ¨ç½²è§„èŒƒ

### UbuntuæœåŠ¡å™¨éƒ¨ç½²é…ç½®
```yaml
# âœ… Ubuntuç”Ÿäº§éƒ¨ç½²å·¥ä½œæµ
deploy-ubuntu-production:
  name: ğŸš€ Ubuntuç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  runs-on: ubuntu-22.04
  timeout-minutes: 30
  needs: [build-ubuntu-images, integration-tests]
  if: github.ref == 'refs/heads/main' && github.event_name == 'push'

  environment:
    name: production-ubuntu
    url: https://zk-agent.com

  steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®kubectl for Ubuntu
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: ğŸ” é…ç½®Ubuntu Kubernetesè®¤è¯
      run: |
        echo "${{ secrets.KUBE_CONFIG_UBUNTU }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: ğŸ”„ Ubuntuè“ç»¿éƒ¨ç½²
      run: |
        # éƒ¨ç½²åˆ°Ubuntuç»¿è‰²ç¯å¢ƒ
        kubectl apply -f k8s/ubuntu/green/

        # ç­‰å¾…Ubuntuéƒ¨ç½²å°±ç»ª
        kubectl rollout status deployment/zk-agent-green -n production-ubuntu --timeout=600s

        # Ubuntuç¯å¢ƒå¥åº·æ£€æŸ¥
        kubectl wait --for=condition=ready pod -l app=zk-agent-green,os=ubuntu -n production-ubuntu --timeout=300s

    - name: ğŸ§ª Ubuntuç”Ÿäº§çƒŸé›¾æµ‹è¯•
      run: |
        # Ubuntuç¯å¢ƒåŠŸèƒ½æµ‹è¯•
        curl -f https://green.zk-agent.com/health
        curl -f https://green.zk-agent.com/api/health

        # Ubuntuç³»ç»Ÿèµ„æºæ£€æŸ¥
        kubectl top nodes
        kubectl top pods -n production-ubuntu

    - name: ğŸ”„ Ubuntuæµé‡åˆ‡æ¢
      run: |
        # Ubuntuç¯å¢ƒæµé‡åˆ‡æ¢
        kubectl patch service zk-agent-service -n production-ubuntu \
          -p '{"spec":{"selector":{"version":"green","os":"ubuntu"}}}'

    - name: â³ éªŒè¯Ubuntuéƒ¨ç½²
      run: |
        # éªŒè¯Ubuntuç”Ÿäº§ç¯å¢ƒ
        for i in {1..10}; do
          curl -f https://zk-agent.com/health && break
          sleep 30
        done

        # Ubuntuç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        kubectl get nodes -l kubernetes.io/os=linux
        kubectl describe node -l kubernetes.io/os=linux | grep -E "Kernel|OS|Container"
```

## ğŸ“ˆ Ubuntuç›‘æ§é…ç½®

### Ubuntuç³»ç»Ÿç›‘æ§
```yaml
# âœ… Ubuntu Prometheusç›‘æ§é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-ubuntu-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'ubuntu-nodes'
        static_configs:
          - targets: ['node-exporter:9100']
        relabel_configs:
          - source_labels: [__address__]
            target_label: instance
          - target_label: os
            replacement: ubuntu

      - job_name: 'zk-agent-ubuntu'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['production-ubuntu']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: ubuntu_node

      - job_name: 'ubuntu-system-metrics'
        static_configs:
          - targets: ['localhost:9100']
        metrics_path: /metrics
        params:
          collect[]:
            - cpu
            - meminfo
            - diskstats
            - filesystem
            - netdev
            - systemd

---
# âœ… Ubuntuå‘Šè­¦è§„åˆ™
apiVersion: v1
kind: ConfigMap
metadata:
  name: ubuntu-alert-rules
data:
  ubuntu-alerts.yml: |
    groups:
      - name: ubuntu-system-alerts
        rules:
          # Ubuntuç³»ç»Ÿèµ„æºå‘Šè­¦
          - alert: UbuntuHighCpuUsage
            expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
              os: ubuntu
            annotations:
              summary: "UbuntuæœåŠ¡å™¨CPUä½¿ç”¨ç‡è¿‡é«˜"
              description: "UbuntuèŠ‚ç‚¹ {{ $labels.instance }} CPUä½¿ç”¨ç‡: {{ $value }}% > 80%"

          - alert: UbuntuHighMemoryUsage
            expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
            for: 5m
            labels:
              severity: warning
              os: ubuntu
            annotations:
              summary: "UbuntuæœåŠ¡å™¨å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
              description: "UbuntuèŠ‚ç‚¹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡: {{ $value }}% > 85%"

          - alert: UbuntuDiskSpaceHigh
            expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes)) * 100 > 90
            for: 5m
            labels:
              severity: critical
              os: ubuntu
            annotations:
              summary: "UbuntuæœåŠ¡å™¨ç£ç›˜ç©ºé—´ä¸è¶³"
              description: "UbuntuèŠ‚ç‚¹ {{ $labels.instance }} ç£ç›˜ä½¿ç”¨ç‡: {{ $value }}% > 90%"

          - alert: UbuntuSystemdServiceDown
            expr: node_systemd_unit_state{state="active"} == 0
            for: 2m
            labels:
              severity: critical
              os: ubuntu
            annotations:
              summary: "Ubuntuç³»ç»ŸæœåŠ¡å¼‚å¸¸"
              description: "UbuntuæœåŠ¡ {{ $labels.name }} åœ¨èŠ‚ç‚¹ {{ $labels.instance }} ä¸Šå¤„äºéæ´»åŠ¨çŠ¶æ€"
```

## ğŸ§ Ubuntu Dockerfileä¼˜åŒ–

### Ubuntuä¸“ç”¨Dockerfile
```dockerfile
# âœ… Ubuntuç”Ÿäº§ç¯å¢ƒä¼˜åŒ–Dockerfile
FROM ubuntu:22.04 as base

# è®¾ç½®Ubuntuç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV UBUNTU_VERSION=22.04

# å®‰è£…UbuntuåŸºç¡€ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Node.js (Ubuntuæ¨èæ–¹å¼)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# å®‰è£…Python (Ubuntuç³»ç»ŸPython)
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3.11-pip \
    python3.11-venv \
    python3.11-dev \
    && ln -s /usr/bin/python3.11 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
COPY requirements.txt ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production \
    && python -m pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# åˆ›å»ºérootç”¨æˆ·ï¼ˆUbuntuå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN groupadd -r ubuntu-app && useradd -r -g ubuntu-app ubuntu-app \
    && chown -R ubuntu-app:ubuntu-app /app

USER ubuntu-app

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["npm", "start"]
```

## âš ï¸ Ubuntuå®‰å…¨è¦æ±‚

### Ubuntuå®‰å…¨é…ç½®
```bash
# âœ… Ubuntuå®‰å…¨åŠ å›ºè„šæœ¬
#!/bin/bash
set -euo pipefail

echo "ğŸ”’ å¼€å§‹Ubuntuå®‰å…¨åŠ å›º..."

# æ›´æ–°ç³»ç»Ÿ
apt-get update && apt-get upgrade -y

# å®‰è£…å®‰å…¨å·¥å…·
apt-get install -y \
    ufw \
    fail2ban \
    unattended-upgrades \
    apt-listchanges

# é…ç½®é˜²ç«å¢™
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
cat << 'EOF' > /etc/apt/apt.conf.d/50unattended-upgrades
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
    "${distro_id}:${distro_codename}-updates";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
EOF

# å¯ç”¨fail2ban
systemctl enable fail2ban
systemctl start fail2ban

echo "âœ… Ubuntuå®‰å…¨åŠ å›ºå®Œæˆ"
```

### Ubuntuæ€§èƒ½è¦æ±‚
- **å¯åŠ¨æ—¶é—´**: Ubuntuå®¹å™¨å¯åŠ¨ â‰¤ 30ç§’
- **å†…å­˜å ç”¨**: åŸºç¡€é•œåƒ â‰¤ 500MB
- **æ„å»ºæ—¶é—´**: Ubuntué•œåƒæ„å»º â‰¤ 10åˆ†é’Ÿ
- **ç½‘ç»œå»¶è¿Ÿ**: UbuntuèŠ‚ç‚¹é—´é€šä¿¡ â‰¤ 1ms
- **ç£ç›˜IO**: Ubuntuå­˜å‚¨å“åº” â‰¤ 10ms

---

## ğŸ§ Ubuntu Dockerfileä¼˜åŒ–

### Ubuntuä¸“ç”¨Dockerfile
```dockerfile
# âœ… Ubuntuç”Ÿäº§ç¯å¢ƒä¼˜åŒ–Dockerfile
FROM ubuntu:22.04 as base

# è®¾ç½®Ubuntuç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV UBUNTU_VERSION=22.04

# å®‰è£…UbuntuåŸºç¡€ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Node.js (Ubuntuæ¨èæ–¹å¼)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# å®‰è£…Python (Ubuntuç³»ç»ŸPython)
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3.11-pip \
    python3.11-venv \
    python3.11-dev \
    && ln -s /usr/bin/python3.11 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
COPY requirements.txt ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production \
    && python -m pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# åˆ›å»ºérootç”¨æˆ·ï¼ˆUbuntuå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN groupadd -r ubuntu-app && useradd -r -g ubuntu-app ubuntu-app \
    && chown -R ubuntu-app:ubuntu-app /app

USER ubuntu-app

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["npm", "start"]
```

## âš ï¸ Ubuntuå®‰å…¨è¦æ±‚

### Ubuntuå®‰å…¨é…ç½®
```bash
# âœ… Ubuntuå®‰å…¨åŠ å›ºè„šæœ¬
#!/bin/bash
set -euo pipefail

echo "ğŸ”’ å¼€å§‹Ubuntuå®‰å…¨åŠ å›º..."

# æ›´æ–°ç³»ç»Ÿ
apt-get update && apt-get upgrade -y

# å®‰è£…å®‰å…¨å·¥å…·
apt-get install -y \
    ufw \
    fail2ban \
    unattended-upgrades \
    apt-listchanges

# é…ç½®é˜²ç«å¢™
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
cat << 'EOF' > /etc/apt/apt.conf.d/50unattended-upgrades
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
    "${distro_id}:${distro_codename}-updates";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
EOF

# å¯ç”¨fail2ban
systemctl enable fail2ban
systemctl start fail2ban

echo "âœ… Ubuntuå®‰å…¨åŠ å›ºå®Œæˆ"
```

### Ubuntuæ€§èƒ½è¦æ±‚
- **å¯åŠ¨æ—¶é—´**: Ubuntuå®¹å™¨å¯åŠ¨ â‰¤ 30ç§’
- **å†…å­˜å ç”¨**: åŸºç¡€é•œåƒ â‰¤ 500MB
- **æ„å»ºæ—¶é—´**: Ubuntué•œåƒæ„å»º â‰¤ 10åˆ†é’Ÿ
- **ç½‘ç»œå»¶è¿Ÿ**: UbuntuèŠ‚ç‚¹é—´é€šä¿¡ â‰¤ 1ms
- **ç£ç›˜IO**: Ubuntuå­˜å‚¨å“åº” â‰¤ 10ms

---

**å‚è€ƒæ–‡æ¡£**:
- [CI/CDæŒ‡å¯¼æ–‡æ¡£](mdc:docs/CI_CD_GUIDELINES.md)
- [é¡¹ç›®æ¶æ„è§„èŒƒ](mdc:.cursor/rules/01-project-architecture.mdc)
- [Ubuntuå®˜æ–¹æ–‡æ¡£](https://ubuntu.com/server/docs)
- [Kubernetes UbuntuèŠ‚ç‚¹é…ç½®](https://kubernetes.io/docs/setup/production-environment/)
